
Automaticamente gera atualiza√ß√µes CDC para todas as tabelas Delta Lake.

```sql
SELECT *
FROM table_changes('table_name', start_version, [end_version])
```

Quando usar CDF
- üü© Tabelas que incluem atualiza√ß√µes e dele√ß√µes
- üü© Apenas uma pequena parcela dos registros s√£o atualizados por vez

Quando n√£o usar CDF
- üõë Tabelas que apenas inserem registros
- üõë A maioria dos registros s√£o atualizados por vez

### Habilitando CDF

```sql
CREATE TABLE myTable (...)
TBLPROPERTIES (delta.enableChangeDataFeed = true)

ALTER TABLE myTable
SET TBLPROPERTIES (delta.enableChangeDataFeed = true)
```

```sql
DESCRIBE TABLE EXTENDED customers
```

| col_name         | data_type                              | comment |
| ---------------- | -------------------------------------- | ------- |
| ...              | ...                                    | ...     |
| Table Properties | [delta.enableChangeDataFeed=true, ...] |         

> [!tip] Leitura na vers√£o python
> Tamb√©m √© poss√≠vel fazer a mesma consulta com a API do PySpark
> ```python
>  cdf_df = (spark.readStream
>		  .format("delta")
>		  .option("readChangeData", True)
>		  .option("startingVersion", 2)
>		  .table("customers"))
> ```

### Campos

Quando consultamos as altera√ß√µes dos dados temos 3 novas colunas:
- `_change_type`: tipo de altera√ß√£o efetuada: atualiza√ß√£o, inser√ß√£o ou remo√ß√£o.
- `_commit_version`: vers√£o do registro da tabela. Cada nova fornada de atualiza√ß√µes na tabela essa vers√£o √© acrescida em 1
- `_commit_timestamp`: hor√°rio da verifica√ß√£o da tabela

### Armazenamento das altera√ß√µes de dados

 As altera√ß√µes de dados s√£o armazenadas em uma pasta junto aos pr√≥prios dados da tabela.
  
  ```python
  üóÉÔ∏è customers
  ‚î£ üìÇ _delta_log            # altera√ß√µes da tabela delta
  ‚î£ üìÇ _change_data          # altera√ß√µes dos registros da tabela
  ‚îó ... dados da tabela
  ```

### Exemplo

Vamos considerar a habilita√ß√£o de CDF para uma tabela de clientes.

| Nome             | Pa√≠s |
| ---------------- | ---- |
| Bruno            | null |
| Comandando Fidel | Cuba |

Habilitamos a op√ß√£o de CDF pelo c√≥digo:

```sql
ALTER TABLE customers
SET TBLPROPERTIES (delta.enableChangeDataFeed = true)
```

Como podemos perceber as propriedades da tabela foram alteradas e agora temos CDF habilitado. Nesse caso quando essa tabela receber novos registros suas altera√ß√µes ser√£o catalogadas automaticamente.

Vamos adicionar mais um cliente para nossa tabela e alterar o Pa√≠s do Bruno.

| Nome             | Pa√≠s   |
| ---------------- | ------ |
| Bruno            | Brasil |
| Comandando Fidel | Cuba   |
| J√∫lio            | Brasil |

```sql
SELECT *
FROM table_changes("customers", 2) -- (nome_tabela, vers√£o)
```

| Nome  | Pa√≠s   | _change_type    | _commit_version | _commit_timestamp       |
| ----- | ------ | --------------- | --------------- | ----------------------- |
| Bruno | null   | update_preimage | 3               | 2024-07-23 11:40:00.000 |
| Bruno | Brasil | update_posimage | 3               | 2024-07-23 11:40:00.000 |
| J√∫lio | Brasil | insert          | 3               | 2024-07-23 11:40:00.000 |
Apenas os registros alterados ou inseridos est√£o catalogados nas altera√ß√µes, o registro do Comandante Fidel n√£o teve altera√ß√£o ent√£o n√£o existem registros catalogados.
